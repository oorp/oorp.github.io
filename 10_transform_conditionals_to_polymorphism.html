<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<title>10. Transform Conditionals to Polymorphism</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#transform-conditionals-to-polymorphism">10. Transform Conditionals to Polymorphism</a>
<ul class="sectlevel2">
<li><a href="#forces-7">Forces</a></li>
<li><a href="#overview-8">Overview</a></li>
<li><a href="#transform-self-type-checks">10.1 Transform Self Type Checks</a></li>
<li><a href="#transform-client-type-checks">10.2 Transform Client Type Checks</a></li>
<li><a href="#factor-out-state">10.3 Factor out State</a></li>
<li><a href="#factor-out-strategy">10.4 Factor out Strategy</a></li>
<li><a href="#introduce-null-object">10.5 Introduce Null Object</a></li>
<li><a href="#transform-conditionals-into-registration">10.6 Transform Conditionals into Registration</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="transform-conditionals-to-polymorphism"><a class="anchor" href="#transform-conditionals-to-polymorphism"></a>10. Transform Conditionals to Polymorphism</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After duplicated code, data containers and god classes, one of the most striking signs of misplaced responsibilities in object-oriented software is the occurrence of large methods consisting almost entirely of case statements that test the type of some argument.</p>
</div>
<div class="paragraph">
<p>Although case statements are not inherently bad, in object-oriented code they are frequently a sign that the object doing the testing is assuming responsibilities that would better be distributed to the objects being tested. Big conditionals arise naturally over time, just as duplicated code does. As the software is adapted to handle new cases, these cases pop up as conditionals in the code. The problem with these big conditionals is that they can make the code much more fragile in the long term.</p>
</div>
<div class="sect2">
<h3 id="forces-7"><a class="anchor" href="#forces-7"></a>Forces</h3>
<div class="paragraph">
<p>The following forces are at play:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As requirements change over time, classes in a software system will have to be adapted to handle new, special cases.</p>
</li>
<li>
<p>Adding new classes or subclasses to a system clutters the namespace.</p>
</li>
<li>
<p>The quickest way to adapt a working piece of software to handle a new requirement, is often to add a conditional test for the special case at some point in the code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>245</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Over time, a simple design tends to get cluttered with many conditional tests for special cases.</p>
</li>
<li>
<p>Case statements group all the variants into a single place instead of spreading the different cases across different classes. However, they lead to design that is less flexible if the case statement appears in more than one place.</p>
</li>
<li>
<p>In some programming languages, case statements are a more conventional idiom to implement varying behavior than polymorphism.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Large conditionals are often a sign that behavior implemented by clients should probably be be shifted to the provider classes. Typically a new method will be introduced to the provider hierarchy, and the individual cases of the conditional statement will each move to one of the provider classes.</p>
</div>
<div class="paragraph">
<p>Although the symptom is readily recognizable, the technical details and the preferred solution may differ considerably. In particular, when the provider hierarchy already exists, and the conditions explicitly check the class of the provider instance, the refactoring is relatively straightforward. But often the provider hierarchy does not exist, and the conditions test attributes that only implicitly model type information. Furthermore, the conditionals may occur not only in external clients, but even in the provider hierarchy itself.</p>
</div>
</div>
<div class="sect2">
<h3 id="overview-8"><a class="anchor" href="#overview-8"></a>Overview</h3>
<div class="paragraph">
<p>Transform Conditionals to Polymorphism is a pattern language that describes how to redistribute responsibilities to eliminate these large conditionals, thereby reducing coupling between classes, and improving flexibility in the face of future changes.</p>
</div>
<div class="paragraph">
<p>This pattern language consists of six patterns which address the most common problems that occur when conditionals are used to simulate polymorphism. Transform Self Type Checks and Transform Client Type Checks address the most typical cases that arise when explicit type checks are performed. Transform Conditionals into Registration occurs less frequently. We also include Factor out State, Factor out Strategy and Introduce Null Object, not in order to copy three established design patterns (State [p. 295], Strategy [p. 295] and Null Object [p. 294]) but rather to show how these design patterns may apply in a reengineering context to eliminate type-checking conditionals.</p>
</div>
<div class="paragraph">
<p>Figure 10.1 summarizes the relationships and the differences between the patterns.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./media/image35.jpg" alt="image" width="432" height="202"></span></p>
</div>
<div class="paragraph">
<p>Figure 10.1: Relationships between the patterns constituting Transform Conditionals to Polymorphism.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transform Self Type Checks eliminates conditionals over type information in a provider class by <em>introducing subclasses</em> for each type case. The conditional code is replaced by a single polymorphic method call to an instance of one of the new subclasses.</p>
</li>
<li>
<p>Transform Client Type Checks transforms conditionals over type information in a client class by <em>introducing a new method</em> to each of the provider classes. The conditional is replaced by a single polymorphic call to the new method.</p>
</li>
<li>
<p>Factor out State handles a special case of Transform Self Type Checks in which the type information that is being tested may change dynamically. <em>A State [p. 295] object is introduced</em> in the provider class to model the changing state, and the conditional is replaced by a call to a method of the new State object.</p>
</li>
<li>
<p>Factor out Strategy is another special case of Transform Self Type Checks in which the algorithms to handle the various provider cases is factored out by <em>introducing a new Strategy [p. 295] object</em>. The key difference with Factor out State is that the algorithm rather than the state may vary dynamically.</p>
</li>
<li>
<p>Introduce Null Object addresses the special case of Transform Client Type Checks in which the test performed checks whether or not the provider is defined. The conditional is eliminated by <em>introducing a Null Object [p. 294]</em> which implements the appropriate default behavior.</p>
</li>
<li>
<p>Transform Conditionals into Registration addresses the situation in which the conditional is responsible for starting up an external tool based on some attribute of an object to be handled. The solution is to <em>introduce a lookup service</em> where tools are registered as plug-ins. The conditional is then replaced by a simple lookup for the registered plug-in. The solution is then fully dynamic because new plug-ins can be added or removed without any changes to the tool users.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="transform-self-type-checks"><a class="anchor" href="#transform-self-type-checks"></a>10.1 Transform Self Type Checks</h3>
<div class="paragraph">
<p><strong>Intent</strong> _Improve the extensibility of a class by replacing a complex conditional statement with a call to a hook method implemented by subclasses.</p>
</div>
<div class="sect3">
<h4 id="problem-36"><a class="anchor" href="#problem-36"></a>Problem</h4>
<div class="paragraph">
<p>A class is hard to modify or extend because it bundles multiple possible behaviors in complex conditional statements that test some attribute representing the current “type” of the object.</p>
</div>
<div class="paragraph">
<p><em>This problem is difficult because:</em>
* Conceptually simple extensions require many changes to the conditional code.
* Subclassing is next to impossible without duplicating and adapting the methods containing the conditional code.
* Adding a new behavior always results in changes to the same set of methods and always results in adding a new case to the conditional code.</p>
</div>
<div class="paragraph">
<p><em>Yet, solving this problem is feasible because:</em>
* Self type checks simulate polymorphism. The conditional code tells you what subclasses you should have instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="solution-35"><a class="anchor" href="#solution-35"></a>Solution</h4>
<div class="paragraph">
<p>Identify the methods with complex conditional branches. In each case, replace the conditional code with a call to a new hook method. Identify or introduce subclasses corresponding to the cases of the conditional. In each of these subclasses, implement the hook method with the code corresponding to that case in the original case statement.</p>
</div>
<div class="sect4">
<h5 id="detection-2"><a class="anchor" href="#detection-2"></a>Detection</h5>
<div class="paragraph">
<p>Most of the time, the type discrimination will jump in your face while you are working on the code, so this means that you will not really need to detect where the checks are made. However, it can be interesting to have simple techniques to quickly assess if unknown parts of a system suffer from similar practices. This can be a valuable source of information to evaluate the state of a system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Look for long methods with complex decision structures on some immutable attribute of the object that models type information. In particular look for attributes that are set in the constructor and never changed.</p>
</li>
<li>
<p>Attributes that are used to model type information typically take on values from some enumerated type, or from some finite set of constant values. Look for constant definitions whose names represent entities or concepts that one would usually expect to be associated to classes (like RetiredEmployee or PendingOrder). The conditionals will normally just compare the value of a fixed attribute to one of these constant values.</p>
</li>
<li>
<p>Especially look for classes where <em>multiple</em> methods switch on the same attribute. This is another common sign that the attribute is being used to simulate a type.</p>
</li>
<li>
<p>Since methods containing case statements tend to be long, it may help to use a tool that sorts methods by lines of code or visualizes classes and methods according to their size. Alternatively, search for classes or methods with a large number of conditional statements.</p>
</li>
<li>
<p>For languages like C++ or Java where it is common to store the implementation of a class in a separate file, it is straightforward to search for and count the incidence of conditional keywords (if, else, case, <em>etc.</em>). On a UNIX system, for example,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>grep 'switch' <code>find . --name "*.cxx" --print</code></p>
</div>
<div class="paragraph">
<p>enumerates all the files in a directory tree with extension .cxx that contain a switch. Other text processing tools like agrep offer possibilities to pose finer granularity queries. Text processing languages like Perl may be better suited for evaluating some kinds of queries, especially those that span multiple lines.
* <em>C/C++:</em> Legacy C code may simulate classes by means of union types. Typically the union type will have one data member that encodes the actual type. Look for conditional statements that switch on such data members to decide which type to cast a union to and which behavior to employ.</p>
</div>
<div class="paragraph">
<p>In C++ it is fairly common to find classes with data members that are declared as void pointers. Look for conditional statements that cast such pointers to a given type based on the value of some other data member. The type information may be encoded as an enum or (more commonly) as a constant integer value.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Ada:</em> Because Ada 83 did not support polymorphism (or subprogram access types), discriminated record types are often used to simulate</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Figure 10.2: Transformation of explicit type check into self polymorphic method calls.</p>
</div>
<div class="paragraph">
<p>polymorphism. Typically an enumeration type provides the set of variants and the conversion to polymorphism is straightforward in Ada95.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Smalltalk:</em> Smalltalk provides only a few ways to manipulate types. Look for applications of the methods isMemberOf: and isKindOf:, which signal explicit type-checking. Type checks might also be made with tests like self class = anotherClass, or with property tests throughout the hierarchy using methods like isSymbol, isString, isSequenceable, isInteger.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="steps-17"><a class="anchor" href="#steps-17"></a>Steps</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the class to transform and the different conceptual classes that it implements. An enumeration type or set of constants will probably document this well.</p>
</li>
<li>
<p>Introduce a new subclass for each behavior that is implemented (see Figure 10.2). Modify clients to instantiate the new subclasses rather than the original class. Run the tests.</p>
</li>
<li>
<p>Identify all methods of the original class that implement varying behavior by means of conditional statements. If the conditionals are surrounded by other statements, move them to separate, protected hook methods. When each conditional occupies a method of its own, run the tests.</p>
</li>
<li>
<p>Iteratively move the cases of the conditionals down to the corresponding subclasses, periodically running the tests.</p>
</li>
<li>
<p>The methods that contain conditional code should now all be empty. Replace these by abstract methods and run the tests.</p>
</li>
<li>
<p>Alternatively, if there are suitable default behaviors, implement these at the root of the new hierarchy.</p>
</li>
<li>
<p>If the logic required to decide which subclass to instantiate is nontrivial, consider encapsulating this logic as a factory method of the new hierarchy root. Update clients to use the new factory method and run the tests.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tradeoffs-36"><a class="anchor" href="#tradeoffs-36"></a>Tradeoffs</h4>
<div class="sect4">
<h5 id="pros-35"><a class="anchor" href="#pros-35"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p>New behaviors can now be added in a incremental manner, without having to change a set of methods of a single class containing all the behavior. A specific behavior can now be understood independently from the other variations.</p>
</li>
<li>
<p>A new behavior represents its data independently from the others, thereby minimizing the possible interference and increasing the understandability of the separated behaviors.</p>
</li>
<li>
<p>All behaviors now share a common interface, thereby improving their readability.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons-30"><a class="anchor" href="#cons-30"></a>Cons</h5>
<div class="ulist">
<ul>
<li>
<p>All the behaviors are now dispersed into multiple but related abstractions, so getting an overview of the behavior may be more difficult. However, the concepts are related and share the interface represented by the abstract class reducing then the problem.</p>
</li>
<li>
<p>The larger number of classes makes the design more complex, and potentially harder to understand. If the original conditional statements are simple, it may not be worthwhile to perform this transformation.</p>
</li>
<li>
<p>Explicit type checks are not always a problem and we can sometimes tolerate them. Creating new classes increases the number of abstractions in the applications and can clutter namespaces. Hence, explicit type checks may be an alternative to the creation of new classes when:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Figure 10.3: Combining simple delegation and Transform Self Type Checks when the class cannot be subclassed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the set over which the method selection is fixed and will not evolve in the future, and</p>
</li>
<li>
<p>the type check is only made in a few places.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="difficulties-32"><a class="anchor" href="#difficulties-32"></a>Difficulties</h5>
<div class="ulist">
<ul>
<li>
<p>Since the requisite subclasses do not yet exist, it can be hard to tell when conditionals are being used to simulate multiple types.</p>
</li>
<li>
<p>Wherever instances of the transformed class were originally created, now instances of different subclasses must be created. If the instantiation occurred in client code, that code must now be adapted to instantiate the right class. Factory objects or methods may be needed to hide this complexity from clients.</p>
</li>
<li>
<p>If you do not have access to the source code of the clients, it may be difficult or impossible to apply this pattern since you will not be able to change the calls to the constructors.</p>
</li>
<li>
<p>If the case statements test more than one attribute, it may be necessary to support a more complex hierarchy, possibly requiring multiple inheritance. Consider splitting the class into parts, each with its own hierarchy.</p>
</li>
<li>
<p>When the class containing the original conditionals cannot be subclassed, Transform Self Type Checks can be composed with delegation. The idea is to exploit polymorphism on another hierarchy by moving part of the state and behavior of the original class into a separate class to which the method will delegate, as shown in Figure 10.3.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="when-the-legacy-solution-is-the-solution-3"><a class="anchor" href="#when-the-legacy-solution-is-the-solution-3"></a>When the legacy solution is the solution</h5>
<div class="paragraph">
<p>There are some situations in which explicit type-checks may nevertheless be the right solution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The conditional code may be generated from a special tool. Lexical analysers and parsers, for example, may be automatically generated to contain the kind of conditional code we are trying to avoid. In these cases, however, the generated classes should never be manually extended, but simply regenerated from the modified specifications.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-16"><a class="anchor" href="#example-16"></a>Example</h4>
<div class="paragraph">
<p>We worked on a complex system that controls large, physical machines by sending them messages. These messages are represented by the class Message and can be of different types.</p>
</div>
<div class="paragraph">
<p>|
a|
class Message \{ public:</p>
</div>
<div class="paragraph">
<p>_Message();</p>
</div>
<div class="paragraph">
<p>set_value(char* text); set_value(int action); void send(Channel c); void receive(Channel c); &#8230;&#8203;
private: void* data_; int type_;</p>
</div>
<div class="paragraph">
<p>static const int TEXT = 1; static const int ACTION = 2;</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;
}</p>
</div>
<div class="literalblock">
<div class="content">
<pre> a|
Message::send(Channel c) \{ switch (type_) \{ case TEXT:</pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>case ACTION:</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>} } void Client1::doit() \{ &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Message * myMessage = new Message();</p>
</div>
<div class="paragraph">
<p>myMessage&#8594;set_Value("&#8230;&#8203;");</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p>Figure 10.4: Initial design and source code.</p>
</div>
<div class="paragraph">
<p><strong>Before.</strong></p>
</div>
<div class="paragraph">
<p>A message class wraps two different kinds of messages (TEXT and ACTION) that must be serialized to be sent across a network connection as shown in the code and the figure. We would like to be able to send a new kind of message (say VOICE), but this will require changes to several methods of Message as shown in Figure 10.4.</p>
</div>
<div class="paragraph">
<p>|
a|
virtual void send(Channel c) = 0; virtual void receive(Channel c) = 0;</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>};</p>
</div>
<div class="paragraph">
<p>class Text_Message: public Message</p>
</div>
<div class="paragraph">
<p>\{ public:</p>
</div>
<div class="paragraph">
<p>Text_Message(char* text); void send(Channel c); void receive(Channel c); private: char* text;</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>};</p>
</div>
<div class="literalblock">
<div class="content">
<pre> a|
public:</pre>
</div>
</div>
<div class="paragraph">
<p>Action_Message(int action); void send(Channel c); void receive(Channel c); private: int action;</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>};</p>
</div>
<div class="paragraph">
<p>void Client1::doit() \{ &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Message * myMessage = new</p>
</div>
<div class="paragraph">
<p>Text_Message("&#8230;&#8203;"); &#8230;&#8203;
}</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p>Figure 10.5: Resulting hierarchy and source code.</p>
</div>
<div class="paragraph">
<p><strong>After.</strong></p>
</div>
<div class="paragraph">
<p>Since Message conceptually implements two different classes, Text_Message and Action_Message, we introduce these as subclasses of Message, as shown in Figure 10.5. We introduce constructors for the new classes, we modify the clients to construct instances of Text_Message and Action_Message rather than Message, and we remove the set_value() methods. Our regression tests should run at this point.</p>
</div>
<div class="paragraph">
<p>Now we find methods that switch on the type variable. In each case, we move the entire case statement to a separate, protected hook method, unless the switch already occupies the entire method. In the case of send(), this is already the case, so we do not have to introduce a hook method. Again, all our tests should still run.</p>
</div>
<div class="paragraph">
<p>Now we iteratively move cases of the case statements from Message to its subclasses. The TEXT case of Message::send() moves to Text_Message::send() and the ACTION case moves to Action_Message::send(). Every time we move such a case, our tests should still run.</p>
</div>
<div class="paragraph">
<p>Finally, since the original send() method is now empty, it can be redeclared to be abstract (<em>i.e.</em>,virtual void send(Channel) = 0). Again, our tests should run.</p>
</div>
</div>
<div class="sect3">
<h4 id="rationale-30"><a class="anchor" href="#rationale-30"></a>Rationale</h4>
<div class="paragraph">
<p>Classes that masquerade as multiple data types make a design harder to understand and extend. The use of explicit type checks leads to long methods that mix several different behaviors. Introducing new behavior then requires changes to be made to all such methods instead of simply specifying one new class representing the new behavior.</p>
</div>
<div class="paragraph">
<p>By transforming such classes to hierarchies that explicitly represent the multiple data types, you improve cohesion by bringing together all the code concerning a single data type, you eliminate a certain amount of duplicated code (<em>i.e.</em>, the conditional tests), and you make your design more transparent, and consequently easier to maintain.</p>
</div>
</div>
<div class="sect3">
<h4 id="related-patterns-24"><a class="anchor" href="#related-patterns-24"></a>Related Patterns</h4>
<div class="paragraph">
<p>In Transform Self Type Checks the condition to be transformed tests type information that is represented as an attribute of the class itself.</p>
</div>
<div class="paragraph">
<p>If the conditional tests <em>mutable</em> state of the host object, consider instead applying Factor out State [p. 266], or possibly Factor out Strategy [p. 270].</p>
</div>
<div class="paragraph">
<p>If the conditional occurs in a <em>client</em> rather than in the provider class itself, consider applying Transform Client Type Checks [p. 257].</p>
</div>
<div class="paragraph">
<p>If the conditional code tests some type attribute of a second object in order to <em>select some third handler object</em>, consider instead applying Transform Conditionals into Registration [p. 277].</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transform-client-type-checks"><a class="anchor" href="#transform-client-type-checks"></a>10.2 Transform Client Type Checks</h3>
<div class="paragraph">
<p><strong>Intent</strong> _Reduce client/provider coupling by transforming conditional code that tests the type of the provider into a polymorphic call to a new provider method.</p>
</div>
<div class="sect3">
<h4 id="problem-37"><a class="anchor" href="#problem-37"></a>Problem</h4>
<div class="paragraph">
<p>How do you reduce the coupling between clients and providers of services, where the clients explicitly check the type of providers and have the responsibility to compose providers code?</p>
</div>
<div class="paragraph">
<p><em>This problem is difficult because:</em>
* Adding a new subclass to the provider hierarchy requires making changes to many clients, especially where the tests occur.
* Clients and providers will tend to be strongly coupled, since clients are performing actions that should be the responsibility of the providers.</p>
</div>
<div class="paragraph">
<p><em>Yet, solving this problem is feasible because:</em>
* The conditionals tell you to which classes you should transfer behavior.</p>
</div>
</div>
<div class="sect3">
<h4 id="solution-36"><a class="anchor" href="#solution-36"></a>Solution</h4>
<div class="paragraph">
<p>Introduce a new method to the provider hierarchy. Implement the new method in each subclass of the provider hierarchy by moving the corresponding case of the clients conditional to that class. Replace the entire conditional in the client by a simple call to the new method.</p>
</div>
<div class="sect4">
<h5 id="detection-3"><a class="anchor" href="#detection-3"></a>Detection</h5>
<div class="paragraph">
<p>Apply essentially the same techniques described in Transform Self Type Checks to detect case statements, but look for conditions that test the type of a separate service provider which <em>already</em> implements a hierarchy. You should also look for case statements occurring in different clients of the same provider hierarchy.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>_C:_ Legacy C code is not likely to make use of run-time type information (RTTI). Instead, type information will likely be encoded</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>in a data member that takes its value from some enumerated type representing the current class. Look for client code switching on such data members.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Ada:</em> Detecting type tests falls into two cases. If the hierarchy is implemented as a single discriminated record then you will find case statements over the discriminant. If the hierarchy is implemented with tagged types then you cannot write a case statement over the types (they are not discrete); instead an if-then-else structure will be used.</p>
</li>
<li>
<p><em>Smalltalk:</em> As in Transform Self Type Checks, look for applications of isMemberOf: and isKindOf:, and tests like self class = anotherClass.</p>
</li>
<li>
<p><em>Java:</em> Look for applications of the operator instanceof, which tests membership of an object in a specific, known class. Although classes in Java are not objects as in Smalltalk, each class that is loaded into the virtual machine is represented by a single instance of java.lang.Class. It is therefore possible to determine if two objects, x and y belong to the same class by performing the test:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>x.getClass() == y.getClass()</p>
</div>
<div class="paragraph">
<p>Alternatively, class membership may be tested by comparing class names:</p>
</div>
<div class="paragraph">
<p>x.getClass().getName().equals(y.getClass().getName())</p>
</div>
</div>
<div class="sect4">
<h5 id="steps-18"><a class="anchor" href="#steps-18"></a>Steps</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the clients performing explicit type checks.</p>
</li>
<li>
<p>Add a new, empty method to the root of the provider hierarchy representing the action performed in the conditional code (see Figure 10.6).</p>
</li>
<li>
<p>Iteratively move a case of the conditional to some provider class, replacing it with a call to that method. After each move, the regression tests should run.</p>
</li>
<li>
<p>When all methods have been moved, each case of the conditional consists of a call to the new method, so replace the entire conditional by a single call to the new method.</p>
</li>
<li>
<p>Consider making the method abstract in the provider’s root. Alternatively implement suitable default behavior here.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>_<span class="image"><img src="./media/image36.png" alt="image" width="426" height="351"></span>
Figure 10.6: Transformation of explicit type check used to determine which methods of a client should be invoked into polymorphic method calls.</p>
</div>
</div>
<div class="sect4">
<h5 id="other-steps-to-consider"><a class="anchor" href="#other-steps-to-consider"></a>Other Steps to Consider</h5>
<div class="ulist">
<ul>
<li>
<p>It may well be that multiple clients are performing exactly the same test and taking the same actions. In this case, the duplicated code can be replaced by a single method call after one of the clients has been transformed. If clients are performing different tests or taking different actions, then the pattern must be applied once for each conditional.</p>
</li>
<li>
<p>If the case statement does not cover all the concrete classes of the provider hierarchy, a new abstract class may need to be introduced as a common superclass of the concerned classes. The new method will then be introduced only for the relevant subtree. Alternatively, if it is not possible to introduce such an abstract class given the existing inheritance hierarchy, consider implementing the method at the root with either an empty default implementation, or one that raises an exception if it is called for an inappropriate class.</p>
</li>
<li>
<p>If the conditionals are nested, the pattern may need to be applied recursively.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tradeoffs-37"><a class="anchor" href="#tradeoffs-37"></a>Tradeoffs</h4>
<div class="sect4">
<h5 id="pros-36"><a class="anchor" href="#pros-36"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p>The provider hierarchy offers a new, polymorphic service available to other clients as well.</p>
</li>
<li>
<p>The code of the clients is now better organized and does not have to deal anymore with concerns that are now under the responsibility of the provider.</p>
</li>
<li>
<p>All the code concerning the behavior of a single provider is now together in a single location.</p>
</li>
<li>
<p>The fact that the provider hierarchy offers a uniform interface allows providers to be modified without impacting clients.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons-31"><a class="anchor" href="#cons-31"></a>Cons</h5>
<div class="ulist">
<ul>
<li>
<p>Sometimes it is convenient to see the code handling different cases in a single location. Transform Client Type Checks redistributes the logic to the individual provider classes, with the result that the overview is lost.
===== Difficulties</p>
</li>
<li>
<p>Normally instances of the provider classes should be already have been created so we do not have to look for the creation of the instances, however refactoring the interface will affect all clients of the provider classes and must not be undertaken without considering the full consequences of such an action.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="when-the-legacy-solution-is-the-solution-4"><a class="anchor" href="#when-the-legacy-solution-is-the-solution-4"></a>When the legacy solution is the solution</h5>
<div class="paragraph">
<p>Client type checks may nevertheless be the right solution when the provider instance does not yet exist or when its class cannot be extended:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An Abstract Factory [p. 293] object may need to test a type variable in order to know which class to instantiate. For example, a factory may stream objects in from a text file representation, and test some variable that tells it which class the streamed object should belong to.</p>
</li>
<li>
<p>Software that interfaces to a non-object-oriented library, such as a legacy GUI library, may force the developer to simulate the dispatch manually. It is questionable whether, in such cases, it is cost-effective to develop an object-oriented facade to the procedural library.</p>
</li>
<li>
<p>If the provider hierarchy is frozen (<em>e.g.</em>, because the source code is not available), then it will not be possible to transfer behavior to the provider classes. In this case, wrapper classes may be defined to extend the behavior of the provider classes, but the added complexity of defining the wrappers may overwhelm any benefits.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-17"><a class="anchor" href="#example-17"></a>Example</h4>
<div class="sect4">
<h5 id="before-2"><a class="anchor" href="#before-2"></a>Before</h5>
<div class="paragraph">
<p>The following C++ code illustrates misplaced responsibilities since the client must explicitly type check instances of Telephone to determine what action to perform. The code in bold highlights the difficulties with this approach.</p>
</div>
<div class="paragraph">
<p>|
a|
class Telephone \{ public:</p>
</div>
<div class="paragraph">
<p>enum PhoneType \{</p>
</div>
<div class="paragraph">
<p>POTSPHONE, ISDNPHONE, OPERATORPHONE</p>
</div>
<div class="paragraph">
<p>};</p>
</div>
<div class="paragraph">
<p>Telephone() \{}</p>
</div>
<div class="paragraph">
<p>PhoneType phoneType() \{ return myType; }</p>
</div>
<div class="paragraph">
<p>private:</p>
</div>
<div class="paragraph">
<p>PhoneType myType; protected:</p>
</div>
<div class="paragraph">
<p>void setPhoneType(PhoneType newType) \{ myType = newType; }
};</p>
</div>
<div class="paragraph">
<p>class POTSPhone : public Telephone \{</p>
</div>
<div class="paragraph">
<p>public:</p>
</div>
<div class="paragraph">
<p>POTSPhone() \{ setPhoneType(POTSPHONE); } void tourneManivelle();</p>
</div>
<div class="paragraph">
<p>void call();
};</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p>|
a|
class ISDNPhone: public Telephone \{ public:</p>
</div>
<div class="paragraph">
<p>_ISDNPhone() \{ setPhoneType(ISDNPHONE);} void initializeLine();</p>
</div>
<div class="paragraph">
<p>void connect();
}; &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>class OperatorPhone: public Telephone \{ public:</p>
</div>
<div class="paragraph">
<p>OperatorPhone() \{ setPhoneType(OPERATORPHONE); }</p>
</div>
<div class="paragraph">
<p>void operatorMode(bool onOffToggle); void call();</p>
</div>
<div class="paragraph">
<p>};</p>
</div>
<div class="paragraph">
<p>void initiateCalls(Telephone ** phoneArray, int numOfCalls) \{ for(int i = 0; i&lt;numOfCalls ;i++ ) \{ Telephone * p = phoneArray[i];</p>
</div>
<div class="paragraph">
<p>switch(p-&#8594;phoneType()) \{ case Telephone::POTSPHONE: \{ POTSPhone *potsp = (POTSPhone *) p;</p>
</div>
<div class="paragraph">
<p>potsp-&#8594;tourneManivelle();</p>
</div>
<div class="paragraph">
<p>potsp-&#8594;call(); break;</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>case Telephone::ISDNPHONE: \{ ISDNPhone *isdnp = (ISDNPhone *) p;</p>
</div>
<div class="paragraph">
<p>isdnp-&#8594;initializeLine(); isdnp-&#8594;connect(); break;</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>case Telephone::OPERATORPHONE: \{ OperatorPhone *opp = (OperatorPhone *) p;</p>
</div>
<div class="paragraph">
<p>opp-&#8594;operatorMode(true);</p>
</div>
<div class="paragraph">
<p>opp-&#8594;call();</p>
</div>
<div class="paragraph">
<p>break;</p>
</div>
<div class="paragraph">
<p>}
default: cerr &lt;&lt; "Unrecognized Phonetype" &lt;&lt; endl;</p>
</div>
<div class="paragraph">
<p>};</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p>Figure 10.7: Transforming explicit type checks to polymorphic method invocations.</p>
</div>
</div>
<div class="sect4">
<h5 id="after-1"><a class="anchor" href="#after-1"></a>After</h5>
<div class="paragraph">
<p>After applying the pattern the client code will look like the following. (See also Figure 10.7.)</p>
</div>
<div class="paragraph">
<p>|
a|
class Telephone \{ public:</p>
</div>
<div class="paragraph">
<p>Telephone() \{}</p>
</div>
<div class="paragraph">
<p>virtual void makeCall() = 0;
};</p>
</div>
<div class="paragraph">
<p>Class POTSPhone : public Telephone \{ void tourneManivelle();</p>
</div>
<div class="paragraph">
<p>void call();</p>
</div>
<div class="paragraph">
<p>public:</p>
</div>
<div class="paragraph">
<p>POTSPhone() \{} void makeCall();
};</p>
</div>
<div class="paragraph">
<p>void POTSPhone::makeCall() \{ this-&#8594;tourneManivelle();</p>
</div>
<div class="paragraph">
<p>this-&#8594;call();</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>class ISDNPhone: public Telephone \{</p>
</div>
<div class="paragraph">
<p>a|
void initializeLine(); void connect();</p>
</div>
<div class="paragraph">
<p>public:</p>
</div>
<div class="paragraph">
<p>ISDNPhone() \{ } void makeCall();</p>
</div>
<div class="paragraph">
<p>};</p>
</div>
<div class="paragraph">
<p>void ISDNPhone::makeCall() \{ this-&#8594;initializeLine();</p>
</div>
<div class="paragraph">
<p>this-&#8594;connect();</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>class OperatorPhone: public Telephone \{ void operatorMode(bool onOffToggle); void call();</p>
</div>
<div class="paragraph">
<p>public:</p>
</div>
<div class="paragraph">
<p>_OperatorPhone() \{ }</p>
</div>
<div class="paragraph">
<p>void makeCall();
};</p>
</div>
<div class="paragraph">
<p>void OperatorPhone::makeCall() \{ this-&#8594;operatorMode(true); this-&#8594;call();</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>void initiateCalls(Telephone ** phoneArray, int numOfCalls) \{ for(int i = 0; i&lt;numOfCalls ;i++ ) \{ phoneArray[i]-&#8594;makeCall();</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>}</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rationale-31"><a class="anchor" href="#rationale-31"></a>Rationale</h4>
<div class="paragraph">
<p>Riel states, “Explicit case analysis on the type of an object is usually an error. The designer should use polymorphism in most of these cases” [Rie96]. Indeed, explicit type checks in clients are a sign of misplaced responsibilities since they increase coupling between clients and providers. Shifting these responsibilities to the provider will have the following consequences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The client and the provider will be more weakly coupled since the client will only need to explicitly know the root of the provider hierarchy instead of all of its concrete subclasses.</p>
</li>
<li>
<p>The provider hierarchy may evolve more gracefully, with less chance of breaking client code.</p>
</li>
<li>
<p>The size and complexity of client code is reduced. The collaborations between clients and providers become more abstract.</p>
</li>
<li>
<p>Abstractions implicit in the old design (<em>i.e.</em>, the actions of the conditional cases) will be made explicit as methods, and will be available to other clients.</p>
</li>
<li>
<p>Code duplication may be reduced (if the same conditionals occur multiply).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="related-patterns-25"><a class="anchor" href="#related-patterns-25"></a>Related Patterns</h4>
<div class="paragraph">
<p>InTransform Client Type Checks the conditional is made on the type information of a provider class. The same situation occurs in Introduce Null Object where the conditional tests over null value before invoking the methods. From this point of view, Introduce Null Object is a specialization of Transform Client Type Checks.</p>
</div>
<div class="paragraph">
<p>Transform Conditionals into Registration handles the special case in which the client’s conditional is used to select a third object (typically an external application or tool) to handle the argument.</p>
</div>
<div class="paragraph">
<p>Replace Conditional with Polymorphism [p. 292] is the core refactoring of this reengineering pattern, so the reader may refer to the steps described in [FBB<sup>+</sup>99].</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="factor-out-state"><a class="anchor" href="#factor-out-state"></a>10.3 Factor out State</h3>
<div class="paragraph">
<p><strong>Intent</strong> _Eliminate complex conditional code over an object’s state by applying the State design pattern.</p>
</div>
<div class="sect3">
<h4 id="problem-38"><a class="anchor" href="#problem-38"></a>Problem</h4>
<div class="paragraph">
<p>How do you make a class whose behavior depends on a complex evaluation of its current state more extensible?</p>
</div>
<div class="paragraph">
<p><em>This problem is difficult because:</em>
* There are several complex conditional statements spread out over the methods of the object. Adding new behavior may affect these conditionals in subtle ways.
* Whenever new possible states are introduced, all the methods that test state have to be modified.</p>
</div>
<div class="paragraph">
<p><em>Yet, solving this problem is feasible because:</em>
* The object’s instance variables are typically used to model different abstract states, each of which has its own behavior. If you can identify these abstract states, you can factor the state and the behavior out into a set of simpler, related classes.</p>
</div>
</div>
<div class="sect3">
<h4 id="solution-37"><a class="anchor" href="#solution-37"></a>Solution</h4>
<div class="paragraph">
<p>Apply the State [p. 295] pattern, <em>i.e.</em>, encapsulate the state-dependent behavior into separate objects, delegate calls to these objects and keep the state of the object consistent by referring to the right instance of these state objects (see figure 47).</p>
</div>
<div class="paragraph">
<p>As in Transform Self Type Checks, transform complex conditional code that tests over quantified states into delegated calls to state classes. Apply the State [p. 295] pattern, delegating each conditional case to a separate State object. We invite the reader to read State and State Patterns [p. 295] for a deep description of the problem and discussion [GHJV95] [ABW98] [DA97]. Here we only focus on the reengineering aspects of the pattern.</p>
</div>
<div class="sect4">
<h5 id="steps-19"><a class="anchor" href="#steps-19"></a>Steps</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the interface of a state and the number of states.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Figure 10.8: Transformation to go from a state pattern simulated using explicit state conditional to a situation where the state pattern has been applied.</p>
</div>
<div class="paragraph">
<p>If you are lucky, each conditional will partition the state space in the same way, and the number of states will equal the number of cases in each conditional. In case the conditionals overlap, a finer partitioning will be required.</p>
</div>
<div class="paragraph">
<p>The interface of a state depends on how the state information is accessed and updated, and may need to be refined in the subsequent steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new abstract class, State, representing the interface of the state.</p>
</li>
<li>
<p>Create a new class subclass of State for each state.</p>
</li>
<li>
<p>Define methods of the interface identified in Step 1 in each of the state classes by copying the corresponding code of the conditional to the new method. Do not forget to change the state of the instance variable in the Context to refer to the right instance of State class. The State methods have the responsibility to change the Context so that it always refers to the next state instance.</p>
</li>
<li>
<p>Add a new instance variable in the Context class.</p>
</li>
<li>
<p>You may have to have a reference from the State to the Context class to invoke the state transitions from the State classes.</p>
</li>
<li>
<p>Initialize the newly created instance to refer to a default state class instance.</p>
</li>
<li>
<p>Change the methods of the Context class containing the tests to delegate the call to the instance variable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Step 4 can be performed using the Extract Method operation of the Refactoring Browser. Note that after each step, the regression tests should still run. The critical step is the last one, in which behavior is delegated to the new state objects.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tradeoffs-38"><a class="anchor" href="#tradeoffs-38"></a>Tradeoffs</h4>
<div class="sect4">
<h5 id="pros-37"><a class="anchor" href="#pros-37"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p><em>Limited Impact.</em> The public interface of the original class does not have to change. Since the state instances are accessed by delegation from the original object, the clients are unaffected. In the straightforward case the application of this pattern has a limited impact on the clients.
===== Cons</p>
<div class="ulist">
<ul>
<li>
<p>The systematic application of this pattern may lead to an explosion in the number of classes.</p>
</li>
<li>
<p>This pattern should not be applied when:</p>
<div class="ulist">
<ul>
<li>
<p>there are too many possible states, or the number of states is not fixed</p>
</li>
<li>
<p>it is hard to determine from the code how and when state transitions occur.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="when-the-legacy-solution-is-the-solution-5"><a class="anchor" href="#when-the-legacy-solution-is-the-solution-5"></a>When the legacy solution is the solution</h5>
<div class="paragraph">
<p>This pattern should not be applied lightly.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the states are clearly identified and it is known that they will not be changed, the legacy solution has the advantage of grouping all the state behavior by functionality instead of spreading it over different subclasses.</p>
</li>
<li>
<p>In certain domains, such as parsers, table-driven behavior, encoded as conditionals over state, are well-understood, and factoring out the state objects may just make the code harder to understand, and hence to maintain.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="known-uses-20"><a class="anchor" href="#known-uses-20"></a>Known Uses</h4>
<div class="paragraph">
<p>The <em>Design Patterns Smalltalk Companion</em> [ABW98] presents a step-by-step code transformation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="factor-out-strategy"><a class="anchor" href="#factor-out-strategy"></a>10.4 Factor out Strategy</h3>
<div class="paragraph">
<p><strong>Intent</strong> _Eliminate conditional code that selects a suitable algorithm by applying the Strategy design pattern.</p>
</div>
<div class="sect3">
<h4 id="problem-39"><a class="anchor" href="#problem-39"></a>Problem</h4>
<div class="paragraph">
<p>How do you make a class whose behavior depends on testing the value of some variable more extensible?</p>
</div>
<div class="paragraph">
<p><em>This problem is difficult because:</em>
* New functionality cannot be added without modifying all the methods containing the conditional code.
* The conditional code may be spread over several classes which make similar decisions about which algorithm to apply.</p>
</div>
<div class="paragraph">
<p><em>Yet, solving this problem is feasible because:</em>
* The alternative behaviors are essentially interchangeable.</p>
</div>
</div>
<div class="sect3">
<h4 id="solution-38"><a class="anchor" href="#solution-38"></a>Solution</h4>
<div class="paragraph">
<p>Apply the Strategy pattern, <em>i.e.</em>, encapsulate the algorithmic dependent behavior into separate objects with polymorphic interfaces and delegate calls to these objects (see Figure 10.9).</p>
</div>
<div class="sect4">
<h5 id="steps-20"><a class="anchor" href="#steps-20"></a>Steps</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the interface of the strategy class.</p>
</li>
<li>
<p>Create a new abstract class, Strategy, representing the interface of the strategies.</p>
</li>
<li>
<p>Create a new class subclass of Strategy for each identified algorithms.</p>
</li>
<li>
<p>Define methods of the interface identified in Step 1 in each of the strategy classes by copying the corresponding code of the test to the method.</p>
</li>
<li>
<p>Add a new instance variable in the Context class to refer to the current strategy.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Figure 10.9: Transformation to go from a state pattern simulated using explicit state conditional to a situation where the state pattern has been applied.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You may have to have a reference from the Strategy to the Context class to provide access to the information maintained by the Context</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>(See difficulties).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Initialize the newly created instance to refer to a default strategy instance.</p>
</li>
<li>
<p>Change the methods of the Context class containing the tests by eliminating the tests and delegating the call to the instance variable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Step 4 can be performed using the Extract Method operation of the Refactoring Browser. Note that after each step, the regression tests should still run. The critical step is the last one, in which behavior is delegated to the new Strategy objects.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tradeoffs-39"><a class="anchor" href="#tradeoffs-39"></a>Tradeoffs</h4>
<div class="sect4">
<h5 id="pros-38"><a class="anchor" href="#pros-38"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p><em>Limited Impact.</em> The public interface of the original class does not have to change. Since the Strategy instances are accessed by delegation from the original object, the clients are unaffected. In a straightforward case the application of this pattern has a limited impact on the clients. However, the Context interface will be reduced because</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>all the previously implemented algorithms are now moved to Strategy classes. So you have to check the invocations of these methods and decide on a per case base.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>After applying this pattern, you will be able to plug new strategies without impacting modifying the interface of the Context. Adding a new strategy does not require to recompile the Context class and its clients.</p>
</li>
<li>
<p>After applying this pattern, the interface of the Context class and the Strategy classes will be clearer.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons-33"><a class="anchor" href="#cons-33"></a>Cons</h5>
<div class="ulist">
<ul>
<li>
<p>The systematic application of this pattern may lead to a class explosion. If you have 20 different algorithms you may not want to have 20 new classes each with only one method.</p>
</li>
<li>
<p>Object explosion. Strategies increase the number of instances in an application.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="difficulties-34"><a class="anchor" href="#difficulties-34"></a>Difficulties</h5>
<div class="ulist">
<ul>
<li>
<p>There are several ways to share information between the Context and the Strategy objects, and the tradeoffs can be subtle. The information can be passed as argument when the Strategy method is invoked, the Context object itself can be passed as argument, or the Strategy objects can hold a reference to their context. If the relationship between the Context and the Strategy is highly dynamic, then it may be preferable to pass this information as a method argument. More detailed discussions of this issue exist in the literature on the Strategy [p. 295] pattern [GHJV95] [ABW98].
==== Example</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>Design Patterns Smalltalk Companion</em> [ABW98] presents a step-by-step code transformation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="related-patterns-26"><a class="anchor" href="#related-patterns-26"></a>Related Patterns</h4>
<div class="paragraph">
<p>The symptoms and structure of Factor out Strategy bear comparison with</p>
</div>
<div class="paragraph">
<p>Factor out State. The main difference consists in the fact that the Factor out</p>
</div>
<div class="paragraph">
<p>State identifies behavior with different possible states of objects whereas Factor out Strategy is concerned with interchangeable algorithms that are independent of object state. Factor out Strategy allows one to add new strategies without impacting the existing strategy objects.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="introduce-null-object"><a class="anchor" href="#introduce-null-object"></a>10.5 Introduce Null Object</h3>
<div class="paragraph">
<p><strong>Intent</strong> _Eliminate conditional code that tests for null values by applying the Null Object design pattern.</p>
</div>
<div class="sect3">
<h4 id="problem-40"><a class="anchor" href="#problem-40"></a>Problem</h4>
<div class="paragraph">
<p>How can you ease modification and extension of a class in presence of repeated tests for null values?</p>
</div>
<div class="paragraph">
<p><em>This problem is difficult because:</em>
* Client methods are always testing that certain values are not null before actually invoking their methods.
* Adding a new subclass to the client hierarchy requires testing null values before invoking some of the provider methods.</p>
</div>
<div class="paragraph">
<p><em>Yet, solving this problem is feasible because:</em>
* The client does not need to know that the provider represents a null value.</p>
</div>
</div>
<div class="sect3">
<h4 id="solution-39"><a class="anchor" href="#solution-39"></a>Solution</h4>
<div class="paragraph">
<p>Apply the Null Object [p. 294] pattern, <em>i.e.</em>, encapsulate the null behavior as a separate provider class so that the client class does not have to perform a null test.</p>
</div>
<div class="sect4">
<h5 id="detection-4"><a class="anchor" href="#detection-4"></a>Detection</h5>
<div class="paragraph">
<p>Look for idiomatic null tests.</p>
</div>
<div class="paragraph">
<p>Null tests may take different forms, depending on the programming language and the kind of entity being tested. In Java, for example, a null object reference has the value null, whereas in C++ a null object pointer has the value 0.</p>
</div>
</div>
<div class="sect4">
<h5 id="steps-21"><a class="anchor" href="#steps-21"></a>Steps</h5>
<div class="paragraph">
<p>Fowler discusses in detail the necessary refactoring steps [FBB<sup>+</sup>99].</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./media/image37.jpg" alt="image" width="432" height="220"></span></p>
</div>
<div class="paragraph">
<p>Figure 10.10: Transformation from a situation based on explicit test of null value to a situation where a Null Object is introduced.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the interface required for the null behavior. (This will normally be identical to that of the non-null object.)</p>
</li>
<li>
<p>Create a new abstract superclass as a superclass of the RealObject class.</p>
</li>
<li>
<p>Create a new subclass of the abstract superclass with a name starting with No or Null.</p>
</li>
<li>
<p>Define default methods into the Null Object class.</p>
</li>
<li>
<p>Initialize the instance variable or structure that was checked to now hold at least an instance of the Null Object class.</p>
</li>
<li>
<p>Remove the conditional tests from the client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you still want to be able to test for null values in a clean way, you may introduce a query method called isNull in RealObject and Null Object classes, as described by Fowler [FBB<sup>+</sup>99].</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tradeoffs-40"><a class="anchor" href="#tradeoffs-40"></a>Tradeoffs</h4>
<div class="sect4">
<h5 id="pros-39"><a class="anchor" href="#pros-39"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p>The client code is much simpler after applying the pattern.</p>
</li>
<li>
<p>The pattern is relatively simple to apply since the interface of the provider does not have to be modified.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cons</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>The provider hierarchy becomes more complex.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="difficulties-35"><a class="anchor" href="#difficulties-35"></a>Difficulties</h5>
<div class="ulist">
<ul>
<li>
<p>Multiple clients may not agree on the reasonable default behavior of the Null Object. In this case, multiple Null Object classes may need to be defined.
===== When the legacy solution is the solution</p>
<div class="ulist">
<ul>
<li>
<p>If clients do not agree on a common interface.</p>
</li>
<li>
<p>When very little code uses the variable directly or when the code that uses the variable is well-encapsulated in a single place.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-19"><a class="anchor" href="#example-19"></a>Example</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">The following Smalltalk code is taken from Woolf [Woo98]. Initially the code contains explicit null tests</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="smalltalk">a|
VisualPart&gt;&gt;objectWantedControl

...

↑ctrl isNil ifFalse:

[ctrl isControlWanted ifTrue:[self] ifFalse:[nil]]

|

It is then transformed into :

[cols=&quot;&quot;,]
|
a|
VisualPart&gt;&gt;objectWantedControl

...

↑ctrl isControlWanted ifTrue:[self]

ifFalse:[nil]

Controller&gt;&gt;isControlWanted

↑self viewHasCursor

NoController&gt;&gt;isControlWanted

↑false

|</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transform-conditionals-into-registration"><a class="anchor" href="#transform-conditionals-into-registration"></a>10.6 Transform Conditionals into Registration</h3>
<div class="paragraph">
<p><strong>Intent</strong> _Improve the modularity of a system by replacing conditionals in clients by a registration mechanism.</p>
</div>
<div class="sect3">
<h4 id="problem-41"><a class="anchor" href="#problem-41"></a>Problem</h4>
<div class="paragraph">
<p>How can you reduce the coupling between <em>tools</em> providing services and <em>clients</em> so that the addition or removal of tools does not lead to changing the code of the clients?</p>
</div>
<div class="paragraph">
<p><em>This problem is difficult because:</em>
* Having one single place to look for all the kinds of tools makes it easy to understand the system and easy to add new tools.
* However, every time you remove a <em>tool</em>, you have to remove one case in some conditional statement, else certain parts (<em>tool clients</em>) would still reflect the presence of the removed tools, leading to fragile systems. Then every time you add a new tool, you have to add a new conditional in all the tool clients.</p>
</div>
<div class="paragraph">
<p><em>Yet, solving this problem is feasible because:</em>
* Long conditionals make it easy to identify the different type of tools used.</p>
</div>
</div>
<div class="sect3">
<h4 id="solution-40"><a class="anchor" href="#solution-40"></a>Solution</h4>
<div class="paragraph">
<p>Introduce a <em>registration mechanism</em> to which each tool is responsible for registering itself, and transform the <em>tool clients</em> to query the registration repository instead of performing conditionals.</p>
</div>
<div class="sect4">
<h5 id="steps-22"><a class="anchor" href="#steps-22"></a>Steps</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class describing <em>plug-in objects</em>, <em>i.e.</em>, an object encapsulating the information necessary for registering a tool. Although the internal structure of this class depends on the purpose of the registration, a plug-in should provide the necessary information so the tool manager can <em>identify</em> it, <em>create</em> instance of the represented tool and <em>invoke</em> methods. To invoke a tool method, a method or a similar mechanism like a block closure or inner class should be stored in the plug-in object.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Figure 10.11: Transforming conditionals in tool users by introducing a registration mechanism.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define a class representing the <em>plug-in manager</em>, <em>i.e.</em>, that manages the plug-in objects and that will be queried by the tool clients to check the presence of the tools. This class will certainly be a singleton since the plug-ins representing the tools available should not be lost if a new instance of the plug-in manager is created.</p>
</li>
<li>
<p>For each case of the conditional, define a plug-in <em>object</em> associated with the given tool. This plug-in object should be created and registered automatically when the tool it represents is loaded, and it should be unregistered if and when the tool becomes unavailable. Sometimes information from the tool client should be passed to the tool. The current tool client can be passed as argument when the tool is invoked.</p>
</li>
<li>
<p>Transform the entire conditional expression into a query to the tool manager object. This query should return a tool associated to the query and invoke it to access the wished functionality.</p>
</li>
<li>
<p>Remove any tool client actions that directly activate tools. This behavior is now the responsibility of the plug-in manager.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The client or the plug-in object may have the responsibility to invoke a tool. It is better to let the plug-in object having this responsibility because it already holds the responsibility of representing how to represent the tools and let the clients just says that they need a tool action.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-20"><a class="anchor" href="#example-20"></a>Example</h4>
<div class="paragraph">
<p>In Squeak [IKM<sup>+</sup>97], the FileList is a tool that allows the loading of different kinds of files, such as Smalltalk code, JPEG images, MIDI files, HTML, and so on. Depending on the suffix of the selected file, the FileList proposes different actions to the user. We show in the example the loading of the different file depending on their format.</p>
</div>
<div class="sect4">
<h5 id="before-3"><a class="anchor" href="#before-3"></a>Before</h5>
<div class="paragraph">
<p>The FileList implementation creates different menu items representing the different possible actions depending on the suffix of the files. The dynamic part of the menu is defined in the method menusForFileEnding: which takes a file suffix as its argument and returns a menu item containing the label of the menu item and the name of the corresponding method that should be invoked on the FileList object.</p>
</div>
<div class="paragraph">
<p>|
a|
FileList&gt;&gt;menusForFileEnding: suffix</p>
</div>
<div class="paragraph">
<p>(suffix = 'jpg') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label:'open image in a window'.</p>
</div>
<div class="paragraph">
<p>selector: #openImageInWindow].</p>
</div>
<div class="paragraph">
<p>(suffix = 'morph') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label: 'load as morph'.</p>
</div>
<div class="paragraph">
<p>selector: #openMorphFromFile].</p>
</div>
<div class="paragraph">
<p>(suffix = 'mid') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label: 'play midi file'.</p>
</div>
<div class="paragraph">
<p>selector: #playMidiFile].</p>
</div>
<div class="paragraph">
<p>(suffix = 'st') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label: 'fileIn'.</p>
</div>
<div class="paragraph">
<p>selector: #fileInSelection].</p>
</div>
<div class="paragraph">
<p>(suffix = 'swf') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label: 'open as Flash'.</p>
</div>
<div class="paragraph">
<p>selector: #openAsFlash].</p>
</div>
<div class="paragraph">
<p>(suffix = '3ds') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label: 'Open 3DS file'.</p>
</div>
<div class="paragraph">
<p>selector: #open3DSFile].</p>
</div>
<div class="paragraph">
<p>(suffix = 'wrl') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label: 'open in Wonderland'.</p>
</div>
<div class="paragraph">
<p>selector: #openVRMLFile].</p>
</div>
<div class="paragraph">
<p>(suffix = 'html') ifTrue:</p>
</div>
<div class="paragraph">
<p>a|
[↑MenuItem label: 'open in html browser'.</p>
</div>
<div class="paragraph">
<p>selector: #openInBrowser].</p>
</div>
<div class="paragraph">
<p>(suffix = '*') ifTrue:</p>
</div>
<div class="paragraph">
<p>[↑MenuItem label: 'generate HTML'.</p>
</div>
<div class="paragraph">
<p>selector:#renderFile].</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p>The methods whose selectors are associated in the menu are implemented in the FileList class. We give two examples here. First the method checks if the tool it needs is available, if not it generates a beep, otherwise the corresponding tool is created and then used to handle the selected file.</p>
</div>
<div class="paragraph">
<p>|
a|
FileList&gt;&gt;openInBrowser</p>
</div>
<div class="paragraph">
<p>Smalltalk at: #Scamper ifAbsent: [↑ self beep].</p>
</div>
<div class="paragraph">
<p>Scamper openOnUrl: (directory url , fileName encodeForHTTP)
FileList&gt;&gt;openVRMLFile</p>
</div>
<div class="paragraph">
<p>| scene |</p>
</div>
<div class="paragraph">
<p>Smalltalk at: #Wonderland ifAbsent: [↑ self beep]. scene := Wonderland new. scene makeActorFromVRML: self fullName.</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
</div>
<div class="sect4">
<h5 id="after-2"><a class="anchor" href="#after-2"></a>After</h5>
<div class="paragraph">
<p>The solution is to give each tool the responsibility to register itself and let the FileList query the registry of available tools to find which tool can be invoked.</p>
</div>
<div class="paragraph">
<p><em>Step1.</em> The solution is to first create the class ToolPlugin representing the registration of a given tool. Here we store the suffix files, the menu label and the action to be performed when the tools will be invoked.</p>
</div>
<div class="paragraph">
<p>Object subclass: #ToolPlugin instanceVariableNames: 'fileSuffix menuLabelName blockToOpen '</p>
</div>
<div class="paragraph">
<p><em>Step 2.</em> Then the class PluginManager is defined. It defines a structure to hold the registered tools and defines behavior to add, remove and find registered tool.</p>
</div>
<div class="paragraph">
<p>Object subclass: #PluginManager instanceVariableNames: 'plugins '</p>
</div>
<div class="paragraph">
<p>PluginManager&gt;&gt;initialize plugins := OrderedCollection new.</p>
</div>
<div class="paragraph">
<p>PluginManager&gt;&gt;addPlugin : aPlugin plugins add: aRegistree</p>
</div>
<div class="paragraph">
<p>|
a|
PluginManager&gt;&gt;removePlugin: aBlock</p>
</div>
<div class="paragraph">
<p>_(plugins select: aBlock) copy do: [:each| plugins remove: each]
PluginManager&gt;&gt;findToolFor: aSuffix</p>
</div>
<div class="paragraph">
<p>"return a registree of a tool being able to treat file of format aSuffix"</p>
</div>
<div class="paragraph">
<p>↑ plugins detect: [:each| each suffix = aSuffix] ifNone: [nil]</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p>Note that the findToolFor: method could take a block to select which of the plug-in objects satisfying it and that it could return a list of plug-in representing all the tools currently able to treat a given file format.</p>
</div>
<div class="paragraph">
<p><em>Step 3.</em> Then the tools should register themselves when they are loaded in memory. Here we present two registrations, showing that a plug-in object is created for each tool. As the tools need some information from the FileList object such as the filename or the directory, the action that has to be performed takes as a parameter the instance of the FileList object that invokes it ([:fileList |&#8230;&#8203;] in the code below).</p>
</div>
<div class="paragraph">
<p>In Squeak, when a class specifies a class (static) initialize method, this method is invoked once the class is loaded in memory. We then specialize the class methods initialize of the classes Scamper and Wonderland to invoke their class methods toolRegistration defined below:</p>
</div>
<div class="paragraph">
<p>|
a|
Scamper class&gt;&gt;toolRegistration</p>
</div>
<div class="paragraph">
<p>PluginManager uniqueInstance addPlugin:</p>
</div>
<div class="paragraph">
<p>(ToolPlugin forFileSuffix: 'html' openingBlock:</p>
</div>
<div class="paragraph">
<p>[:fileList |</p>
</div>
<div class="paragraph">
<p>self openOnUrl:</p>
</div>
<div class="paragraph">
<p>(fileList directory url , fileList fileName encodeForHTTP)]</p>
</div>
<div class="paragraph">
<p>menuLabelName: 'open in html browser')
Wonderland class&gt;&gt;toolRegistration</p>
</div>
<div class="paragraph">
<p>PluginManager uniqueInstance addPlugin: (ToolPlugin</p>
</div>
<div class="paragraph">
<p>a|
forFileSuffix: 'wrl' openingBlock:</p>
</div>
<div class="paragraph">
<p>[:fileList |</p>
</div>
<div class="paragraph">
<p>| scene | scene := self new.
scene makeActorFromVRML: fileList fullName] menuLabelName: 'open in Wonderland')</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p>In Squeak, when a class is removed from the system, it receives the message removeFromSystem. Here we then specialize this method for every tool so that it can unregister itself.</p>
</div>
<div class="paragraph">
<p>|
a|
Scamper class&gt;&gt;removeFromSystem</p>
</div>
<div class="paragraph">
<p>super removeFromSystem.</p>
</div>
<div class="paragraph">
<p>PluginManager uniqueInstance removePlugin: [:plugin| plugin forFileSuffix = 'html']</p>
</div>
<div class="paragraph">
<p>Wonderland class&gt;&gt;removeFromSystem</p>
</div>
<div class="paragraph">
<p>super removeFromSystem.</p>
</div>
<div class="paragraph">
<p>PluginManager uniqueInstance removePlugin: [:plugin| plugin forFileSuffix = 'wrl']</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
<div class="paragraph">
<p><em>Step 4.</em> The FileList object now has to use the ToolsManager to identify the right plug-in object depending on the suffix of the selected file. Then if a tool is available for the given suffix, it creates a menu item specifying that the FileList has to be passed as argument of the action block associated with the tool. In the case where there is no tool a special menu is created whose action is to do nothing.</p>
</div>
<div class="paragraph">
<p>|
a|
FileList&gt;&gt;itemsForFileEnding: suffix</p>
</div>
<div class="paragraph">
<p>| plugin |</p>
</div>
<div class="paragraph">
<p>plugin := PluginManager uniqueInstance findToolFor: suffix ifAbsent: [nil].</p>
</div>
<div class="paragraph">
<p>↑ plugins isNil ifFalse: [Menu label: (plugin menuLabelName) actionBlock: (plugin openingBlock) withParameter: self]</p>
</div>
<div class="paragraph">
<p>ifTrue: [ErrorMenu new label: 'no tool available for the suffix ', suffix]</p>
</div>
<div class="paragraph">
<p>|</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tradeoffs-41"><a class="anchor" href="#tradeoffs-41"></a>Tradeoffs</h4>
<div class="sect4">
<h5 id="pros-40"><a class="anchor" href="#pros-40"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p>By applying Transform Conditionals into Registration you obtain a system which is both dynamic and flexible. New tools can be added without impacting tool clients.</p>
</li>
<li>
<p>Tool clients no longer have to check whether a given tool is available. The registration mechanism ensures you that the action can be performed.</p>
</li>
<li>
<p>The interaction protocol between tools and tool clients is now normalized.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons-34"><a class="anchor" href="#cons-34"></a>Cons</h5>
<div class="ulist">
<ul>
<li>
<p>You have to define two new classes, one for the object representing tool representation (plugin) and one for the object managing the registered tools (plugin manager).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="difficulties-36"><a class="anchor" href="#difficulties-36"></a>Difficulties</h5>
<div class="ulist">
<ul>
<li>
<p>While transforming a branch of the conditional into a plug-in object, you will have to define an action associated with the tools via the plug-in object. To ensure a clear separation and full dynamic registration, this action should be defined on the tool and not anymore on the tool client. However, as the tool may need some information from the tool client, the tool client should be passed to the tool as a parameter when the action is invoked. This changes the protocol between the tool and the tool client from a single invocation on the tool client to a method invocation to the tool with an extra parameter. This also implies that in some cases the tool client class have to define new public or friend methods to allow the tools to access the tool client right information.</p>
</li>
<li>
<p>If each single conditional branch is associated only with a single tool, only one plug-in object is needed. However, if the same tool can be called in different ways we will have to create multiple plug-in objects.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="when-the-legacy-solution-is-the-solution-7"><a class="anchor" href="#when-the-legacy-solution-is-the-solution-7"></a>When the legacy solution is the solution</h5>
<div class="ulist">
<ul>
<li>
<p>If there is only a single tool client class, if all the tools are always available, and if you will never add or remove a tool at run-time, a conditional is simpler.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="related-patterns-27"><a class="anchor" href="#related-patterns-27"></a>Related Patterns</h4>
<div class="paragraph">
<p>Both Transform Conditionals into Registration and Transform Client Type Checks eliminate conditional expressions that decide which method should be invoked on which object. The key difference between the two patterns is that Transform Client Type Checks moves behavior from the client to the service provider, whereas Transform Conditionals into Registration deals with behavior that cannot be moved because it is implemented by an external tool.</p>
</div>
</div>
<div class="sect3">
<h4 id="script-identifying-simulated-switches-in-c"><a class="anchor" href="#script-identifying-simulated-switches-in-c"></a>Script: Identifying simulated switches in C++</h4>
<div class="paragraph">
<p>This Perl script searches the methods in C++ files and lists the occurrences of statements used to simulate case statement with if then else <em>i.e.</em>, matching the following expression: elseXif where X can be replaced by , //&#8230;&#8203; or some white space including carriage return.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="perl">#!/opt/local/bin/perl
$/ = '::';
# new record delim.,
$elseIfPattern = 'else[\s\n]*{?[\s\n]*if';
$linecount = 1; while (&lt;&gt;) { s/(//.*)//g; # remove C++ style comments $lc = (split /\n/) -- 1; # count lines
if(/$elseIfPattern/) {
# count # of lines until first
# occurrence of &quot;else if&quot;
$temp = join(&quot;&quot;,$`,$&amp;);
$l = $linecount + split(/\n/,$temp) -- 1;
# count the occurrences of else--if pairs,
# flag the positions for an eventual printout
$swc = s/(else)([\s\n]*{?[\s\n]*if)
        /$1\n        * HERE *$2/g;
printf &quot;\n%s: Statement with
%2d else--if's, first at: %d&quot;,
$ARGV, $swc, $l;
}
   $linecount += $lc; if(eof) {
   close ARGV; $linecount = 0;

   print &quot;\n&quot;;
}
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-01-26 06:13:54 MEZ
</div>
</div>
</body>
</html>